<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Germana Expert - Recapitulare Gre»ôeli</title>
    <style>
        :root { --bg-reader: #ffffff; --font-size: 20px; --top-font-size: 17px; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; background: #f0f2f5; padding-top: 85px; }
        
        #top-bar { position: fixed; top: 0; left: 0; width: 100%; height: 80px; background: #28a745; color: white; 
                   display: flex; align-items: center; justify-content: space-between; z-index: 1000; font-weight: bold; padding: 0 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); 
                   font-size: var(--top-font-size); }
        
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .section-title { font-size: 12px; font-weight: bold; color: #666; text-transform: uppercase; margin-bottom: 10px; display: block; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .btn { border: none; padding: 12px; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; font-size: 13px; text-align: center; }
        .propriu { background: #007bff; } .btn-test { background: #673ab7; }
        
        .quiz-option { width: 100%; padding: 15px; margin: 5px 0; border: 2px solid #ddd; border-radius: 10px; background: #f8f9fa; font-size: 16px; text-align: left; cursor: pointer; }
        .correct { background: #d4edda !important; border-color: #28a745 !important; }
        .wrong { background: #f8d7da !important; border-color: #dc3545 !important; }
        
        #reader-area { line-height: 1.8; font-size: var(--font-size); background: var(--bg-reader); min-height: 120px; padding: 15px; border-radius: 8px; }
        .settings-panel { display: none; position: fixed; top: 85px; left: 10px; right: 10px; background: white; z-index: 2000; border-radius: 15px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 2px solid #28a745; max-height: 80vh; overflow-y: auto; }
        .item-row { display: flex; justify-content: space-between; background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 6px; border: 1px solid #ddd; }
        .hidden { display: none; }
        input, textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-top: 5px; }
        .score-box { text-align: center; padding: 20px; }
    </style>
</head>
<body>

<div id="top-bar">
    <span id="status-text">Recapitulare B1</span>
    <button onclick="toggleSettings()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">‚öôÔ∏è</button>
</div>

<div id="settings-panel" class="settings-panel">
    <h3 style="margin-top:0">‚öôÔ∏è Op»õiuni Test</h3>
    <div style="background: #f0f7ff; padding: 10px; border-radius: 8px;">
        <label><b>üì• ImportƒÉ Test Nou:</b></label>
        <textarea id="web-import-area" style="height:60px" placeholder="√éntrebare | Corect | Gre»ôit1"></textarea>
        <input type="text" id="web-import-title" placeholder="Titlu Test">
        <button class="btn btn-test" style="width:100%; margin-top:5px;" onclick="importExtern('T')">SalveazƒÉ</button>
    </div>
    <button class="btn" style="width:100%; margin-top:15px; background:#343a40" onclick="toggleSettings()">√énchide</button>
</div>

<div class="card">
    <div class="grid">
        <button class="btn propriu" style="background:#4caf50" onclick="incarcaPreset('a1')">A1</button>
        <button class="btn propriu" style="background:#ff9800" onclick="incarcaPreset('b1')">B1</button>
        <button class="btn btn-test" onclick="toggleSectiune('zona-adaugare')">+ TEST</button>
    </div>
    <div id="zona-adaugare" class="hidden">
        <input type="text" id="inp-titlu" placeholder="Titlu...">
        <textarea id="inp-text" style="height:80px" placeholder="√éntrebare | Corect | Gre»ôit1"></textarea>
        <button class="btn btn-test" style="width:100%; margin-top:5px;" onclick="salveaza('T')">AdaugƒÉ</button>
    </div>
</div>

<div class="card">
    <span class="section-title">üìÇ Testele Mele</span>
    <div id="lista-materiale"></div>
</div>

<div class="card">
    <div id="reader-area">Alege un test pentru a √Æncepe...</div>
</div>

<script>
    let quizOriginal = []; // Toate √ÆntrebƒÉrile testului curent
    let quizCurrent = [];  // √éntrebƒÉrile care ruleazƒÉ acum
    let mistakes = [];     // √éntrebƒÉrile gre»ôite √Æn runda asta
    let currentIdx = 0;
    let score = 0;
    let testTitle = "";

    window.onload = refreshLista;

    function toggleSettings() { let p = document.getElementById('settings-panel'); p.style.display = (p.style.display === 'block') ? 'none' : 'block'; }
    function toggleSectiune(id) { document.getElementById(id).classList.toggle('hidden'); }

    function refreshLista() {
        const cont = document.getElementById('lista-materiale');
        let db = JSON.parse(localStorage.getItem('mea_data') || '[]');
        cont.innerHTML = db.map((item, i) => `
            <div class="item-row">
                <span onclick="preparaQuiz(${i})" style="cursor:pointer; flex:1;"><b>üß† ${item.titlu}</b></span>
                <span onclick="sterge(${i})" style="color:red; cursor:pointer; padding:0 10px;">X</span>
            </div>
        `).join('');
    }

    function preparaQuiz(index) {
        let db = JSON.parse(localStorage.getItem('mea_data') || '[]');
        testTitle = db[index].titlu;
        quizOriginal = db[index].continut.split('\n').map(line => {
            let parts = line.split('|').map(p => p.trim());
            return { q: parts[0], correct: parts[1], options: parts.slice(1) };
        }).filter(item => item.q && item.correct);
        
        startNewRound(quizOriginal);
    }

    function startNewRound(questions) {
        quizCurrent = [...questions];
        mistakes = [];
        currentIdx = 0;
        score = 0;
        showQuestion();
    }

    function showQuestion() {
        if(currentIdx >= quizCurrent.length) {
            showFinalScore();
            return;
        }
        let item = quizCurrent[currentIdx];
        let shuffledOpts = [...item.options].sort(() => Math.random() - 0.5);
        
        let html = `<div><b>${testTitle} (${currentIdx + 1}/${quizCurrent.length})</b><br><br>${item.q}</div><br>`;
        shuffledOpts.forEach(opt => {
            html += `<button class="quiz-option" onclick="checkAnswer(this, '${opt}', '${item.correct}')">${opt}</button>`;
        });
        document.getElementById('reader-area').innerHTML = html;
        document.getElementById('status-text').innerText = "Alege varianta corectƒÉ";
    }

    function checkAnswer(btn, selected, correct) {
        let allBtns = document.querySelectorAll('.quiz-option');
        allBtns.forEach(b => b.onclick = null); // DezactiveazƒÉ restul butoanelor

        if(selected === correct) {
            btn.classList.add('correct');
            score++;
            document.getElementById('status-text').innerText = "Corect! ‚úÖ";
        } else {
            btn.classList.add('wrong');
            document.getElementById('status-text').innerText = "Gre»ôit! ‚ùå";
            mistakes.push(quizCurrent[currentIdx]); // SalvƒÉm √Æntrebarea pentru recapitulare
            
            // ArƒÉtƒÉm »ôi care era cel corect
            allBtns.forEach(b => { if(b.innerText === correct) b.classList.add('correct'); });
        }

        setTimeout(() => { currentIdx++; showQuestion(); }, 1500);
    }

    function showFinalScore() {
        let percent = Math.round((score / quizCurrent.length) * 100);
        let html = `
            <div class="score-box">
                <h2>Rezultat: ${score} / ${quizCurrent.length}</h2>
                <p style="font-size: 24px;">${percent}% Corect</p>
                <button class="btn propriu" style="width:100%; margin-bottom:10px;" onclick="startNewRound(quizOriginal)">RepetƒÉ Tot Testul</button>
        `;

        if(mistakes.length > 0) {
            html += `<button class="btn btn-test" style="width:100%;" onclick="startNewRound(mistakes)">RepetƒÉ doar cele ${mistakes.length} gre»ôite</button>`;
        } else {
            html += `<p style="color:green; font-weight:bold;">Perfect! Nu ai gre»ôit nimic. üåü</p>`;
        }

        html += `<br><br><button class="btn" style="background:#343a40; width:100%;" onclick="location.reload()">√énapoi la listƒÉ</button></div>`;
        document.getElementById('reader-area').innerHTML = html;
        document.getElementById('status-text').innerText = "Test Finalizat";
    }

    function salveaza(tip) {
        const t = document.getElementById('inp-titlu').value || "Quiz";
        const c = document.getElementById('inp-text').value;
        if(!c) return;
        let db = JSON.parse(localStorage.getItem('mea_data') || '[]');
        db.push({ titlu: t, continut: c, tip: tip });
        localStorage.setItem('mea_data', JSON.stringify(db));
        refreshLista(); toggleSectiune('zona-adaugare');
    }

    function sterge(i) {
        if(confirm("»òtergi testul?")) {
            let db = JSON.parse(localStorage.getItem('mea_data') || '[]');
            db.splice(i, 1);
            localStorage.setItem('mea_data', JSON.stringify(db));
            refreshLista();
        }
    }

    function importExtern(tip) {
        const text = document.getElementById('web-import-area').value;
        const titlu = document.getElementById('web-import-title').value || "Import";
        if(!text) return;
        let db = JSON.parse(localStorage.getItem('mea_data') || '[]');
        db.push({ titlu, continut: text, tip });
        localStorage.setItem('mea_data', JSON.stringify(db));
        refreshLista(); toggleSettings();
    }

    function incarcaPreset(n) {
        const p = { 'a1': "Ich ___ Max. | bin | bist | ist", 'b1': "Ich freue mich ___ dich. | auf | √ºber | f√ºr" };
        const temp = [{ titlu: "Preset " + n, continut: p[n], tip: 'T' }];
        testTitle = "Preset " + n;
        quizOriginal = temp[0].continut.split('\n').map(line => {
            let parts = line.split('|').map(p => p.trim());
            return { q: parts[0], correct: parts[1], options: parts.slice(1) };
        });
        startNewRound(quizOriginal);
    }
</script>
</body>
</html>
